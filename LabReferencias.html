<style>
  /* SCROLLBARS */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

  /* MODAL */
  dialog#rules-modal {
    padding: 0; border: none; border-radius: 16px;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
    max-width: 1150px; width: 95%; height: 85vh;
    background: #fff; animation: slideUp 0.3s ease-out; overflow: hidden;
  }
  dialog#rules-modal::backdrop { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
  @keyframes slideUp { from { transform:translateY(20px); opacity:0; } to { transform:translateY(0); opacity:1; } }

  .ref-modal-layout { display: grid; grid-template-columns: 320px 1fr; height: 100%; overflow: hidden; }
  
  /* SIDEBAR */
  .ref-sidebar { 
    background: #f8fafc; border-right: 1px solid #e2e8f0; padding: 25px; 
    display: flex; flex-direction: column; gap: 12px; overflow-y: auto; height: 100%; box-sizing: border-box;
  }
  .ref-title { font-weight: 800; color: #1e293b; font-size: 1.1rem; margin-bottom: 5px; }
  
  .ref-input-group label { display: block; font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 3px; }
  .ref-input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; background: #fff; font-size: 0.9rem; box-sizing: border-box; }
  
  .age-row { display: flex; align-items: flex-end; gap: 5px; }
  .age-input { flex: 1; }
  .unit-select { width: 70px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.8rem; background: #f1f5f9; }

  .btn-add-ref { 
    background: #10b981; color: white; width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 8px; flex-shrink: 0; 
  }
  .btn-add-ref:hover { background: #059669; }
  .btn-close-modal { margin-top: 10px; background: transparent; border: 1px solid #cbd5e1; color: #64748b; padding: 8px; border-radius: 8px; cursor: pointer; font-weight: 600; flex-shrink: 0; }

  /* TABELA */
  .ref-table-wrapper { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
  .ref-table-header { padding: 15px 25px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; background: #fff; flex-shrink: 0; }
  .table-scroll { overflow-y: auto; flex: 1; background: #fff; }
  
  table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
  th { text-align: left; padding: 12px 15px; color: #64748b; background: #f8fafc; position: sticky; top: 0; border-bottom: 1px solid #e2e8f0; z-index: 10; }
  td { padding: 10px 15px; border-bottom: 1px solid #f1f5f9; color: #334155; }
  
  .tag-sexo { padding: 2px 8px; border-radius: 4px; font-weight: 700; font-size: 0.7rem; }
  .tag-sexo.M { background: #dbeafe; color: #1e40af; }
  .tag-sexo.F { background: #fce7f3; color: #db2777; }
  .tag-sexo.A { background: #e2e8f0; color: #475569; }

  /* TAG DE TIPO DE REGRA */
  .tag-tipo { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; border: 1px solid; }
  .tag-tipo.Padr√£o { border-color: #cbd5e1; color: #64748b; background: #f8fafc; }
  .tag-tipo.Prematuro { border-color: #fca5a5; color: #dc2626; background: #fef2f2; }

  .btn-publish { background: #8b5cf6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 5px; font-size: 0.85rem; transition: 0.2s; }
  .btn-publish:hover { background: #7c3aed; transform: translateY(-1px); }
  .btn-refresh { background: white; border: 1px solid #cbd5e1; padding: 6px 10px; border-radius: 6px; cursor: pointer; color: #475569; }
  .btn-refresh:hover { border-color: #94a3b8; color: #1e293b; }
</style>

<dialog id="rules-modal">
  <div class="ref-modal-layout">
    
    <div class="ref-sidebar">
      <div><div class="ref-title">‚ûï Nova Regra</div><p style="font-size:0.75rem; color:#94a3b8; margin:0;">Defina faixas por dias, meses ou anos.</p></div>
      
      <div class="ref-input-group"><label>Nome do Exame</label><input type="text" id="ref-nome" class="ref-input" placeholder="Ex: √Åcido √örico"></div>
      
      <div class="ref-input-group"><label>Tipo de Regra</label>
        <select id="ref-tipo" class="ref-input">
          <option value="Padr√£o">Padr√£o</option>
          <option value="Prematuro">Prematuro</option>
        </select>
      </div>

      <div class="ref-input-group"><label>Sexo</label>
        <select id="ref-sexo" class="ref-input">
          <option value="Ambos">Ambos</option>
          <option value="M">Masculino</option>
          <option value="F">Feminino</option>
        </select>
      </div>

      <hr style="border:0; border-top:1px solid #e2e8f0; margin:5px 0;">

      <div class="ref-input-group"><label>Idade M√≠nima</label>
        <div class="age-row"><input type="number" id="ref-min-val" class="ref-input age-input" value="0"><select id="ref-min-unit" class="unit-select"><option value="1">Dias</option><option value="30">Meses</option><option value="365">Anos</option></select></div>
      </div>
      <div class="ref-input-group"><label>Idade M√°xima</label>
        <div class="age-row"><input type="number" id="ref-max-val" class="ref-input age-input" value="100"><select id="ref-max-unit" class="unit-select"><option value="1">Dias</option><option value="30">Meses</option><option value="365" selected>Anos</option></select></div>
      </div>

      <hr style="border:0; border-top:1px solid #e2e8f0; margin:5px 0;">

      <div style="display:flex; gap:10px;">
        <div class="ref-input-group" style="flex:1"><label>Min (Valor)</label><input type="number" id="ref-val-min" class="ref-input" step="0.01"></div>
        <div class="ref-input-group" style="flex:1"><label>Max (Valor)</label><input type="number" id="ref-val-max" class="ref-input" step="0.01"></div>
      </div>

      <div style="flex:1;"></div>
      <button class="btn-add-ref" onclick="saveReferencia()"><span>üíæ</span> Salvar Regra</button>
      <button class="btn-close-modal" onclick="closeRulesModal()">Fechar</button>
    </div>

    <div class="ref-table-wrapper">
      <div class="ref-table-header">
        <span style="font-weight:700; font-size:1rem; color:#334155;">üìö Regras Cadastradas</span>
        <div style="display:flex; gap:10px;">
          <button onclick="syncToMaster()" class="btn-publish" title="Sobrescreve o Mestre"><span>‚òÅÔ∏è</span> Publicar</button>
          <button onclick="loadReferencias()" class="btn-refresh">üîÑ</button>
        </div>
      </div>
      
      <div class="table-scroll">
        <table id="table-ref">
          <thead><tr><th>Exame</th><th>Tipo</th><th>Sexo</th><th>Faixa Et√°ria</th><th>Refer√™ncia</th><th style="text-align:right">#</th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="ref-loading" style="padding:40px; text-align:center; color:#94a3b8; display:none;">Carregando...</div>
      </div>
    </div>
  </div>
</dialog>

<script>
  function openRulesModal() { document.getElementById('rules-modal').showModal(); loadReferencias(); }
  function closeRulesModal() { document.getElementById('rules-modal').close(); }

  function loadReferencias() {
    const tbody = document.querySelector('#table-ref tbody');
    const loader = document.getElementById('ref-loading');
    tbody.innerHTML = ''; loader.style.display = 'block';

    google.script.run.withSuccessHandler(res => {
      loader.style.display = 'none';
      if(!res.sucesso) { tbody.innerHTML = `<tr><td colspan="6" style="color:red; padding:20px;">${res.erro}</td></tr>`; return; }
      
      const counter = document.getElementById('rules-counter');
      if(counter) counter.innerText = res.dados.length + " Regras";

      if(res.dados.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:30px; color:#94a3b8;">Banco vazio.</td></tr>';
        return;
      }

      res.dados.forEach(r => {
        const tr = document.createElement('tr');
        const fmtAge = (d) => {
          if(d >= 365 && d % 365 < 30) return (d/365).toFixed(0) + " anos";
          if(d >= 30 && d < 365) return (d/30).toFixed(0) + " meses";
          return d + " dias";
        };

        tr.innerHTML = `
          <td style="font-weight:600;">${r.nome}</td>
          <td><span class="tag-tipo ${r.tipo}">${r.tipo}</span></td>
          <td><span class="tag-sexo ${r.sexo}">${r.sexo}</span></td>
          <td>${fmtAge(r.diasMin)} a ${fmtAge(r.diasMax)}</td>
          <td style="color:#15803d; font-weight:600;">${r.min} - ${r.max}</td>
          <td style="text-align:right;"><button onclick="deleteReferencia(${r.id}, this)" style="border:none; cursor:pointer; color:#ef4444;">‚úï</button></td>
        `;
        tbody.appendChild(tr);
      });
    }).apiGetReferenciasDb();
  }

  function saveReferencia() {
    const nome = document.getElementById('ref-nome').value;
    const vMin = document.getElementById('ref-val-min').value;
    const vMax = document.getElementById('ref-val-max').value;
    if(!nome || !vMin || !vMax) return alert("Preencha Nome e Valores.");

    const minAgeVal = parseFloat(document.getElementById('ref-min-val').value) || 0;
    const minAgeUnit = parseFloat(document.getElementById('ref-min-unit').value);
    const maxAgeVal = parseFloat(document.getElementById('ref-max-val').value) || 0;
    const maxAgeUnit = parseFloat(document.getElementById('ref-max-unit').value);

    const regra = {
      nome: nome, 
      tipo: document.getElementById('ref-tipo').value, // NOVO
      sexo: document.getElementById('ref-sexo').value,
      diasMin: Math.floor(minAgeVal * minAgeUnit), 
      diasMax: Math.floor(maxAgeVal * maxAgeUnit),
      min: parseFloat(vMin), 
      max: parseFloat(vMax)
    };

    const btn = document.querySelector('.btn-add-ref');
    const txt = btn.innerText; btn.innerText = "Salvando..."; btn.disabled = true;

    google.script.run.withSuccessHandler(res => {
      btn.innerText = txt; btn.disabled = false;
      if(res.sucesso) {
        document.getElementById('ref-val-min').value = ''; document.getElementById('ref-val-max').value = '';
        loadReferencias();
      } else { alert("Erro: " + res.erro); }
    }).apiSalvarReferencia(regra);
  }

  function deleteReferencia(id, btn) {
    if(!confirm("Excluir?")) return;
    btn.innerText = "...";
    google.script.run.withSuccessHandler(res => {
      if(res.sucesso) btn.closest('tr').remove(); else alert(res.erro);
    }).apiExcluirReferencia(id);
  }

  function syncToMaster() {
    if(!confirm("‚ö†Ô∏è ATEN√á√ÉO: Vai SOBRESCREVER o Banco Mestre.\n\nTem certeza?")) return;
    const btn = document.querySelector('.btn-publish');
    const t = btn.innerHTML; btn.innerHTML = "‚è≥ Enviando..."; btn.disabled = true;
    google.script.run.withSuccessHandler(res => {
      btn.innerHTML = t; btn.disabled = false;
      alert(res.sucesso ? "‚úÖ " + res.msg : "‚ùå " + res.erro);
    }).apiExportarParaMaster();
  }
</script>
