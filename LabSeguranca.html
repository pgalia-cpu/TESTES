<style>
  /* Layout B√°sico */
  .sec-layout { display: grid; grid-template-columns: 260px 1fr; gap: 25px; height: 100%; max-width: 1400px; margin: 0 auto; }
  
  /* Sidebar */
  .sec-sidebar { background: #fff; border-right: 1px solid #e5e7eb; padding: 20px; border-radius: 8px; display: flex; flex-direction: column; gap: 15px; border: 1px solid #e5e7eb; }
  .sec-header { font-weight: 800; color: #1e293b; padding-bottom: 10px; border-bottom: 1px solid #e5e7eb; font-size:1.1rem; letter-spacing:-0.02em; }
  
  /* Cards de KPI (Mini) */
  .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
  .kpi-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px; text-align: center; }
  .kpi-val { font-size: 1.2rem; font-weight: 800; color: #2563eb; display: block; line-height: 1; }
  .kpi-label { font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: 600; margin-top: 4px; display: block; }
  
  /* Bot√µes de Visualiza√ß√£o (Icons) */
  .view-toggles { display: flex; gap: 5px; background: #f1f5f9; padding: 4px; border-radius: 8px; margin-bottom: 10px; }
  .view-btn { flex: 1; border: none; background: transparent; padding: 8px; cursor: pointer; border-radius: 6px; color: #64748b; transition: 0.2s; font-size: 0.85rem; font-weight: 600; }
  .view-btn.active { background: #fff; color: #2563eb; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
  .view-btn:hover:not(.active) { color: #334155; }

  /* Filtros */
  .sec-filter label { font-size: 0.75rem; font-weight: 700; color: #64748b; display: block; margin-bottom: 4px; }
  .sec-select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; background: #fff; }

  /* Bot√£o A√ß√£o */
  .btn-sec { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; margin-top: auto; box-shadow: 0 4px 6px rgba(220, 38, 38, 0.2); transition: transform 0.1s; }
  .btn-sec:active { transform: translateY(1px); }

  /* √Årea Gr√°fica */
  .sec-chart-area { background: #fff; border-radius: 12px; border: 1px solid #e5e7eb; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); position: relative; }
  .chart-title { font-size: 1.2rem; font-weight: 700; color: #1e293b; margin-bottom: 5px; }
  .chart-subtitle { font-size: 0.9rem; color: #64748b; margin-bottom: 20px; }
</style>

<section id="view-seguranca" class="view-section">
  <div class="sec-layout">
    
    <div class="sec-sidebar">
      <div class="sec-header">üõ°Ô∏è Safety Lab</div>
      
      <div class="kpi-grid">
        <div class="kpi-card">
          <span class="kpi-val" id="kpi-incidencia">-</span>
          <span class="kpi-label">Incid√™ncia</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-val" id="kpi-graves" style="color:#dc2626">-</span>
          <span class="kpi-label">Graves</span>
        </div>
      </div>

      <div class="sec-filter">
        <label>MEDICAMENTO</label>
        <select id="sec-med" class="sec-select"><option>Carregando...</option></select>
      </div>

      <div class="sec-filter">
        <label>FILTRAR GRAVIDADE</label>
        <select id="sec-grav" class="sec-select" onchange="updateSecCharts()">
          <option value="all">Todas</option>
          <option value="Grave">Apenas Graves</option>
          <option value="Moderada">Moderadas+</option>
        </select>
      </div>
      
      <div class="sec-filter">
        <label>SEXO</label>
        <select id="sec-sexo" class="sec-select" onchange="updateSecCharts()">
          <option value="all">Todos</option>
          <option value="M">Masculino</option>
          <option value="F">Feminino</option>
        </select>
      </div>

      <hr style="border:0; border-top:1px solid #f1f5f9; margin:10px 0;">

      <div class="sec-filter">
        <label>TIPO DE AN√ÅLISE</label>
        <div class="view-toggles">
          <button class="view-btn active" onclick="setSecView('matrix', this)">Matriz</button>
          <button class="view-btn" onclick="setSecView('timeline', this)">Tempo</button>
          <button class="view-btn" onclick="setSecView('pareto', this)">Pareto</button>
        </div>
      </div>

      <button class="btn-sec" onclick="loadSecData()">‚ö†Ô∏è Analisar Risco</button>
    </div>

    <div class="sec-chart-area">
      <div id="sec-chart-container" style="width:100%; height:100%;"></div>
    </div>

  </div>
</section>

<style>
  /* Layout B√°sico */
  .sec-layout { display: grid; grid-template-columns: 260px 1fr; gap: 25px; height: 100%; max-width: 1400px; margin: 0 auto; }
  
  /* Sidebar */
  .sec-sidebar { background: #fff; border-right: 1px solid #e5e7eb; padding: 20px; border-radius: 8px; display: flex; flex-direction: column; gap: 15px; border: 1px solid #e5e7eb; }
  .sec-header { font-weight: 800; color: #1e293b; padding-bottom: 10px; border-bottom: 1px solid #e5e7eb; font-size:1.1rem; letter-spacing:-0.02em; }
  <button class="btn-sec" style="background:#475569; margin-top:10px;" onclick="exportToStackSec()">
  ‚û°Ô∏è Enviar para Fus√£o
  </button>
  /* Cards de KPI (Mini) */
  .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
  .kpi-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 10px; text-align: center; }
  .kpi-val { font-size: 1.2rem; font-weight: 800; color: #2563eb; display: block; line-height: 1; }
  .kpi-label { font-size: 0.7rem; color: #64748b; text-transform: uppercase; font-weight: 600; margin-top: 4px; display: block; }
  
  /* Bot√µes de Visualiza√ß√£o (Icons) */
  .view-toggles { display: flex; gap: 5px; background: #f1f5f9; padding: 4px; border-radius: 8px; margin-bottom: 10px; }
  .view-btn { flex: 1; border: none; background: transparent; padding: 8px; cursor: pointer; border-radius: 6px; color: #64748b; transition: 0.2s; font-size: 0.85rem; font-weight: 600; }
  .view-btn.active { background: #fff; color: #2563eb; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
  .view-btn:hover:not(.active) { color: #334155; }

  /* Filtros */
  .sec-filter label { font-size: 0.75rem; font-weight: 700; color: #64748b; display: block; margin-bottom: 4px; }
  .sec-select { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; background: #fff; }

  /* Bot√£o A√ß√£o */
  .btn-sec { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; margin-top: auto; box-shadow: 0 4px 6px rgba(220, 38, 38, 0.2); transition: transform 0.1s; }
  .btn-sec:active { transform: translateY(1px); }

  /* √Årea Gr√°fica */
  .sec-chart-area { background: #fff; border-radius: 12px; border: 1px solid #e5e7eb; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); position: relative; }
  .chart-title { font-size: 1.2rem; font-weight: 700; color: #1e293b; margin-bottom: 5px; }
  .chart-subtitle { font-size: 0.9rem; color: #64748b; margin-bottom: 20px; }
</style>

<section id="view-seguranca" class="view-section">
  <div class="sec-layout">
    
    <div class="sec-sidebar">
      <div class="sec-header">üõ°Ô∏è Safety Lab</div>
      
      <div class="kpi-grid">
        <div class="kpi-card">
          <span class="kpi-val" id="kpi-incidencia">-</span>
          <span class="kpi-label">Incid√™ncia</span>
        </div>
        <div class="kpi-card">
          <span class="kpi-val" id="kpi-graves" style="color:#dc2626">-</span>
          <span class="kpi-label">Graves</span>
        </div>
      </div>

      <div class="sec-filter">
        <label>MEDICAMENTO</label>
        <select id="sec-med" class="sec-select"><option>Carregando...</option></select>
      </div>

      <div class="sec-filter">
        <label>FILTRAR GRAVIDADE</label>
        <select id="sec-grav" class="sec-select" onchange="updateSecCharts()">
          <option value="all">Todas</option>
          <option value="Grave">Apenas Graves</option>
          <option value="Moderada">Moderadas+</option>
        </select>
      </div>
      
      <div class="sec-filter">
        <label>SEXO</label>
        <select id="sec-sexo" class="sec-select" onchange="updateSecCharts()">
          <option value="all">Todos</option>
          <option value="M">Masculino</option>
          <option value="F">Feminino</option>
        </select>
      </div>

      <hr style="border:0; border-top:1px solid #f1f5f9; margin:10px 0;">

      <div class="sec-filter">
        <label>TIPO DE AN√ÅLISE</label>
        <div class="view-toggles">
          <button class="view-btn active" onclick="setSecView('matrix', this)">Matriz</button>
          <button class="view-btn" onclick="setSecView('timeline', this)">Tempo</button>
          <button class="view-btn" onclick="setSecView('pareto', this)">Pareto</button>
        </div>
      </div>

      <button class="btn-sec" onclick="loadSecData()">‚ö†Ô∏è Analisar Risco</button>

      <button class="btn-sec" style="background:#475569; margin-top:10px;" onclick="exportToStackSec()">üì¶ Empilhar (Fus√£o)</button>
    </div>

    <div class="sec-chart-area">
      <div id="sec-chart-container" style="width:100%; height:100%;"></div>
    </div>

  </div>
</section>

<script>
  let rawSecData = [];
  let secMeta = {};
  let currentSecView = 'matrix';

  function initSegurancaModule(config) {
    // Carrega medicamentos (igual aos outros m√≥dulos)
    if(config.core) google.script.run.withSuccessHandler(l=>{
      const s = document.getElementById('sec-med'); s.innerHTML=''; l.forEach(m=>s.innerHTML+=`<option value="${m}">${m}</option>`);
    }).apiGetMedicamentos(config.core.abaFatos, config.core.colMed);
  }

  function loadSecData() {
    const med = document.getElementById('sec-med').value;
    const btn = document.querySelector('.btn-sec'); btn.innerText = "Calculando..."; btn.disabled = true;
    
    google.script.run.withSuccessHandler(res => {
      btn.innerText = "‚ö†Ô∏è Analisar Risco"; btn.disabled = false;
      if(!res.sucesso) return alert(res.erro);
      
      rawSecData = res.dados;
      secMeta = res.meta; // Total expostos
      updateSecCharts();

    }).apiGetSegurancaData({medicamento: med});
  }

  function updateSecCharts() {
    if(rawSecData.length === 0) return;

    // Filtros
    const gravFilter = document.getElementById('sec-grav').value;
    const sexoFilter = document.getElementById('sec-sexo').value;
    
    const data = rawSecData.filter(d => {
      if(sexoFilter !== 'all' && d.sexo !== sexoFilter) return false;
      if(gravFilter === 'Grave' && !d.gravidade.includes('Grave')) return false;
      if(gravFilter === 'Moderada' && (d.gravidade.includes('Leve'))) return false;
      return true;
    });

    // Atualiza KPIs
    const nEventos = data.length;
    const nGraves = data.filter(d=>d.gravidade.includes('Grave') || d.gravidade.includes('S√©ria')).length;
    const incidencia = ((nEventos / secMeta.totalExpostos) * 100).toFixed(1);
    const pctGraves = nEventos > 0 ? ((nGraves / nEventos) * 100).toFixed(0) : 0;

    document.getElementById('kpi-incidencia').innerText = incidencia + "%";
    document.getElementById('kpi-graves').innerText = pctGraves + "%";

    // Renderiza View Selecionada
    if(currentSecView === 'matrix') renderMatrix(data);
    if(currentSecView === 'timeline') renderTimeline(data);
    if(currentSecView === 'pareto') renderPareto(data);
  }

  function setSecView(view, btn) {
    currentSecView = view;
    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    updateSecCharts();
  }

  // --- RENDERIZADORES ---

  function renderMatrix(data) {
    // Agrupa por Gravidade + Causalidade
    const agg = {};
    data.forEach(d => {
      const k = `${d.gravidade}|${d.causalidade}`;
      agg[k] = (agg[k] || 0) + 1;
    });

    const x=[], y=[], z=[], c=[];
    Object.keys(agg).forEach(k => {
      const [grav, caus] = k.split('|');
      x.push(caus); y.push(grav); z.push(agg[k]);
      // Cor baseada na gravidade
      c.push(grav.includes('Grave') ? '#dc2626' : (grav.includes('Moderada') ? '#f59e0b' : '#3b82f6'));
    });

    const trace = {
      x: x, y: y, mode: 'markers+text',
      text: z, textfont: {color:'white', weight:'bold'},
      marker: { size: z.map(v => Math.max(35, v*5)), color: c }
    };

    Plotly.newPlot('sec-chart-container', [trace], {
      title: '<b>Matriz de Risco</b>',
      xaxis: {title: 'Causalidade (Naranjo)', categoryarray: ['Duvidosa','Poss√≠vel','Prov√°vel','Definida']},
      yaxis: {title: 'Gravidade'},
      template: 'plotly_white'
    });
  }

  function renderTimeline(data) {
    // Scatter Plot: X=Dias, Y=Tipo de RAM
    const trace = {
      x: data.map(d => d.diasAteEvento),
      y: data.map(d => d.descricao),
      mode: 'markers',
      type: 'scatter',
      marker: {
        color: data.map(d => d.gravidade.includes('Grave') ? '#dc2626' : '#3b82f6'),
        size: 10, opacity: 0.7
      },
      text: data.map(d => `Pront: ${d.prontuario}<br>Grav: ${d.gravidade}`),
      hovertemplate: '<b>%{y}</b><br>Dia %{x}<br>%{text}<extra></extra>'
    };

    Plotly.newPlot('sec-chart-container', [trace], {
      title: '<b>Linha do Tempo de Eventos</b> (Inicio Terap√™utico = 0)',
      xaxis: {title: 'Dias ap√≥s in√≠cio'},
      yaxis: {title: 'Tipo de Rea√ß√£o', automargin: true},
      template: 'plotly_white'
    });
  }

  function renderPareto(data) {
    // Histograma de Frequ√™ncia
    const counts = {};
    data.forEach(d => { counts[d.descricao] = (counts[d.descricao] || 0) + 1; });
    
    // Ordenar
    const sortedKeys = Object.keys(counts).sort((a,b) => counts[b] - counts[a]).slice(0, 10); // Top 10
    
    const trace = {
      x: sortedKeys,
      y: sortedKeys.map(k => counts[k]),
      type: 'bar',
      marker: {color: '#1e293b'}
    };

    Plotly.newPlot('sec-chart-container', [trace], {
      title: '<b>Top 10 Rea√ß√µes Adversas</b>',
      xaxis: {title: 'Tipo de RAM'},
      yaxis: {title: 'Contagem'},
      template: 'plotly_white'
    });
  }

  function exportToStackSec() {
    if(!rawSecData || rawSecData.length === 0) return alert("Analise o risco primeiro.");
    
    const exportData = rawSecData.map(d => ({
      prontuario: d.prontuario,
      gravidade: d.gravidade,
      causalidade: d.causalidade,
      tipo: d.descricao
    }));

    const med = document.getElementById('sec-med').value;

    if(window.addToStack) {
      window.addToStack('Seguran√ßa', `Eventos ${med}`, exportData, 'gravidade');
    } else {
      alert("Erro: Stack global n√£o inicializado.");
    }
  }
</script>
